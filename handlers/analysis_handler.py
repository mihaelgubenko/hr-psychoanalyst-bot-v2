"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–Ω–∞–ª–∏–∑–æ–≤ –ª–∏—á–Ω–æ—Å—Ç–∏ –∏ —Ç–µ—Å—Ç–æ–≤
"""

import logging
from typing import Dict, Any, Optional
from telegram import Update
from telegram.ext import ContextTypes, ConversationHandler
from telegram.constants import ParseMode

from ai.adaptive_prompt_manager import PromptType

logger = logging.getLogger(__name__)

class AnalysisHandler:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–Ω–∞–ª–∏–∑–æ–≤ –ª–∏—á–Ω–æ—Å—Ç–∏"""
    
    def __init__(self, ai_client, database):
        self.ai_client = ai_client
        self.database = database
        self.user_data = {}  # user_id -> analysis data
    
    async def start_self_esteem_test(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> str:
        """–ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∞ —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∏"""
        user = update.effective_user
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ context (–≤–∞–∂–Ω–æ –¥–ª—è ConversationHandler!)
        context.user_data['test_type'] = 'self_esteem'
        context.user_data['answers'] = []
        context.user_data['current_question'] = 0
        
        intro_text = """
üìñ **–¢–ï–°–¢ –°–ê–ú–û–û–¶–ï–ù–ö–ò | "–í–æ—Å—Ö–æ–∂–¥–µ–Ω–∏–µ"**

–≠—Ç–æ—Ç —Ç–µ—Å—Ç –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –∫–Ω–∏–≥–µ "–í–æ—Å—Ö–æ–∂–¥–µ–Ω–∏–µ" –∏ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º:

‚ú® –ü–æ–Ω—è—Ç—å —É—Ä–æ–≤–µ–Ω—å –≤–∞—à–µ–π —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∏
üéØ –ù–∞–π—Ç–∏ —Å–≤–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ  
üòå –û—Å–≤–æ–±–æ–¥–∏—Ç—å—Å—è –æ—Ç —Å—Ç—Ä–∞—Ö–æ–≤, –≥–Ω–µ–≤–∞ –∏ –æ–±–∏–¥
üíù –£–ª—É—á—à–∏—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å —Å–æ–±–æ–π –∏ –¥—Ä—É–≥–∏–º–∏

**–ü—Ä–∏–Ω—Ü–∏–ø—ã –∏–∑ –∫–Ω–∏–≥–∏ "–í–æ—Å—Ö–æ–∂–¥–µ–Ω–∏–µ":**
‚Ä¢ –ö–∞–∂–¥—ã–π —á–µ–ª–æ–≤–µ–∫ —Å–æ–∑–¥–∞–Ω –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –º–∏—Å—Å–∏–∏
‚Ä¢ "–î–ª—è –º–µ–Ω—è —Å–æ–∑–¥–∞–Ω –º–∏—Ä" - –≤—ã –≤–∞–∂–Ω—ã –∫–∞–∫ —Ü–µ–ª—ã–π –º–∏—Ä
‚Ä¢ –°–∞–º–æ—É–≤–∞–∂–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –ø–æ–Ω–∏–º–∞–Ω–∏–∏ —Å–≤–æ–µ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
‚Ä¢ –£ –∫–∞–∂–¥–æ–≥–æ –µ—Å—Ç—å —Å–∏–ª—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è

**–§–æ—Ä–º–∞—Ç:** 10 –∫–ª—é—á–µ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
**–í—Ä–µ–º—è:** ~5-7 –º–∏–Ω—É—Ç  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ + –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

üí° *–û—Ç–≤–µ—á–∞–π—Ç–µ –∏—Å–∫—Ä–µ–Ω–Ω–µ - —ç—Ç–æ –∫–ª—é—á –∫ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏!*

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

**–í–æ–ø—Ä–æ—Å 1 –∏–∑ 10:**
–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ —Å–≤–æ—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –∫–∞–∫ –ª–∏—á–Ω–æ—Å—Ç–∏? (1-10)
"""
        
        await update.message.reply_text(intro_text, parse_mode=ParseMode.MARKDOWN)
        return 'SELF_ESTEEM_Q'
    
    async def handle_self_esteem_answer(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> str:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —Ç–µ—Å—Ç–∞ —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∏"""
        user = update.effective_user
        text = update.message.text.strip()
        
        if not text or len(text) < 1:
            await update.message.reply_text(
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–∞–π—Ç–µ –æ—Ç–≤–µ—Ç."
            )
            return 'SELF_ESTEEM_Q'
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ context (–≤–∞–∂–Ω–æ –¥–ª—è ConversationHandler!)
        answers = context.user_data.get('answers', [])
        current_q = context.user_data.get('current_question', 0)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
        answers.append(text)
        current_q += 1
        
        # –û–±–Ω–æ–≤–ª—è–µ–º context
        context.user_data['answers'] = answers
        context.user_data['current_question'] = current_q
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –ª–∏ –≤–æ–ø—Ä–æ—Å—ã (10 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞)
        if current_q >= 10:
            # –í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã - –ø—Ä–æ–≤–æ–¥–∏–º –∞–Ω–∞–ª–∏–∑
            await update.message.reply_text(
                "‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã.\n\n"
                "üîÆ –ü—Ä–æ–≤–æ–∂—É –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≤–∞—à–µ–π —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∏...\n"
                "‚è±Ô∏è –≠—Ç–æ –∑–∞–π–º–µ—Ç 30-60 —Å–µ–∫—É–Ω–¥."
            )
            
            try:
                # –ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –ò–ò
                analysis_result = await self._analyze_self_esteem(user.id, answers)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∏: {e}", exc_info=True)
                await update.message.reply_text(
                    "üòî –ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ.\n\n"
                    "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–Ω–æ–≤–æ."
                )
                context.user_data.clear()
                return ConversationHandler.END
            
            analysis_result = analysis_result if analysis_result else "–ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω."
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            await self._send_analysis_result(update, analysis_result)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            await self.database.save_analysis(
                user.id, 
                user.first_name or f"User_{user.id}", 
                'self_esteem', 
                {
                    'type': 'self_esteem',
                    'answers': answers,
                    'analysis': analysis_result
                }
            )
            
            # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            context.user_data.clear()
            return ConversationHandler.END
        
        # –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        next_question = self._get_next_question(current_q)
        await update.message.reply_text(next_question, parse_mode=ParseMode.MARKDOWN)
        
        return 'SELF_ESTEEM_Q'
    
    async def start_full_analysis(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> str:
        """–ù–∞—á–∞–ª–æ –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"""
        user = update.effective_user
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑
        analyses = await self.database.get_user_analyses(user.id)
        has_full_analysis = any(analysis.analysis_type == 'full' for analysis in analyses)
        
        if has_full_analysis:
            await update.message.reply_text(
                "–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑! –î–ª—è –Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start"
            )
            return 'WAITING_MESSAGE'
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ context
        context.user_data['test_type'] = 'full_analysis'
        context.user_data['answers'] = []
        context.user_data['current_question'] = 0
        
        professional_questions = [
            "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –¥–µ—Ç—Å—Ç–≤–µ. –ö–∞–∫–∏–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª–∏ –≤–∞—à —Ö–∞—Ä–∞–∫—Ç–µ—Ä?",
            "–ß—Ç–æ –≤–∞—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –≤ –∂–∏–∑–Ω–∏? –û—Ç–∫—É–¥–∞ —á–µ—Ä–ø–∞–µ—Ç–µ —ç–Ω–µ—Ä–≥–∏—é?",
            "–ö–∞–∫ –≤—ã —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å —Å–æ —Å—Ç—Ä–µ—Å—Å–æ–º? –û–ø–∏—à–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–ª–æ–∂–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é.",
            "–í –∫–∞–∫–æ–π —Å—Ä–µ–¥–µ –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –ª—É—á—à–µ –≤—Å–µ–≥–æ? –ö–æ–º–∞–Ω–¥–∞ –∏–ª–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ?",
            "–ö–∞–∫–∏–µ –≤–∞—à–∏ –≥–ª–∞–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ö–∏ –∏ –∫–∞–∫ –æ–Ω–∏ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–µ—à–µ–Ω–∏—è?",
            "–ö–∞–∫ –≤—ã –≤–∏–¥–∏—Ç–µ —Å–µ–±—è —á–µ—Ä–µ–∑ 5 –ª–µ—Ç? –ö–∞–∫–∏–µ —Ü–µ–ª–∏ –≤–∞–∂–Ω—ã?",
            "–ß—Ç–æ –±—ã –≤—ã –∏–∑–º–µ–Ω–∏–ª–∏ –≤ —Å–µ–±–µ, –µ—Å–ª–∏ –±—ã –º–æ–≥–ª–∏? –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ?"
        ]
        
        await update.message.reply_text(
            "üíé **–ü–æ–ª–Ω—ã–π –ø—Å–∏—Ö–æ–∞–Ω–∞–ª–∏–∑**\n\n"
            "–û—Ç–ª–∏—á–Ω–æ! –°–µ–π—á–∞—Å —è –ø—Ä–æ–≤–µ–¥—É –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤–∞—à–µ–π –ª–∏—á–Ω–æ—Å—Ç–∏.\n"
            "–ë—É–¥–µ—Ç 7 –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.\n\n"
            "**–í–æ–ø—Ä–æ—Å 1 –∏–∑ 7:**\n"
            f"{professional_questions[0]}"
        )
        
        return 'Q1'
    
    async def handle_full_analysis_answer(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> str:
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"""
        user = update.effective_user
        text = update.message.text.strip()
        
        if not text or len(text) < 20:
            await update.message.reply_text(
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–∞–π—Ç–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç (–º–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤). "
                "–≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞."
            )
            return context.user_data.get('current_question', 'Q1')
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ context
        answers = context.user_data.get('answers', [])
        current_q = context.user_data.get('current_question', 0)
        
        answers.append(text)
        current_q += 1
        
        # –û–±–Ω–æ–≤–ª—è–µ–º context
        context.user_data['answers'] = answers
        context.user_data['current_question'] = current_q
        
        professional_questions = [
            "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –¥–µ—Ç—Å—Ç–≤–µ. –ö–∞–∫–∏–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–ª–∏ –≤–∞—à —Ö–∞—Ä–∞–∫—Ç–µ—Ä?",
            "–ß—Ç–æ –≤–∞—Å –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –≤ –∂–∏–∑–Ω–∏? –û—Ç–∫—É–¥–∞ —á–µ—Ä–ø–∞–µ—Ç–µ —ç–Ω–µ—Ä–≥–∏—é?",
            "–ö–∞–∫ –≤—ã —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å —Å–æ —Å—Ç—Ä–µ—Å—Å–æ–º? –û–ø–∏—à–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å–ª–æ–∂–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é.",
            "–í –∫–∞–∫–æ–π —Å—Ä–µ–¥–µ –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –ª—É—á—à–µ –≤—Å–µ–≥–æ? –ö–æ–º–∞–Ω–¥–∞ –∏–ª–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ?",
            "–ö–∞–∫–∏–µ –≤–∞—à–∏ –≥–ª–∞–≤–Ω—ã–µ —Å—Ç—Ä–∞—Ö–∏ –∏ –∫–∞–∫ –æ–Ω–∏ –≤–ª–∏—è—é—Ç –Ω–∞ —Ä–µ—à–µ–Ω–∏—è?",
            "–ö–∞–∫ –≤—ã –≤–∏–¥–∏—Ç–µ —Å–µ–±—è —á–µ—Ä–µ–∑ 5 –ª–µ—Ç? –ö–∞–∫–∏–µ —Ü–µ–ª–∏ –≤–∞–∂–Ω—ã?",
            "–ß—Ç–æ –±—ã –≤—ã –∏–∑–º–µ–Ω–∏–ª–∏ –≤ —Å–µ–±–µ, –µ—Å–ª–∏ –±—ã –º–æ–≥–ª–∏? –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ?"
        ]
        
        if current_q < 7:
            await update.message.reply_text(
                f"**–í–æ–ø—Ä–æ—Å {current_q + 1} –∏–∑ 7:**\n"
                f"{professional_questions[current_q]}"
            )
            return f'Q{current_q + 1}'
        else:
            # –í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç–≤–µ—Ç–µ–Ω—ã, –ø—Ä–æ–≤–æ–¥–∏–º –∞–Ω–∞–ª–∏–∑
            await update.message.reply_text(
                "üéØ –û—Ç–ª–∏—á–Ω–æ! –í—Å–µ –æ—Ç–≤–µ—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã. "
                "–ü—Ä–æ–≤–æ–∂—É –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Å–∏—Ö–æ–∞–Ω–∞–ª–∏–∑... –≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç."
            )
            
            # –ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –ò–ò
            analysis_result = await self._analyze_full_personality(user.id, answers)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            await self._send_analysis_result(update, analysis_result)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            await self.database.save_analysis(
                user.id, 
                user.first_name or f"User_{user.id}", 
                'full', 
                {
                    'type': 'full',
                    'answers': answers,
                    'analysis': analysis_result
                },
                'paid'
            )
            
            await update.message.reply_text(
                "‚úÖ **–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!**\n\n"
                "–°–ø–∞—Å–∏–±–æ –∑–∞ –¥–æ–≤–µ—Ä–∏–µ. –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∞–Ω–æ–Ω–∏–º–Ω–æ.\n"
                "–î–ª—è –Ω–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start"
            )
            
            # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            context.user_data.clear()
            return ConversationHandler.END
    
    async def _analyze_self_esteem(self, user_id: int, answers: list) -> str:
        """–ê–Ω–∞–ª–∏–∑ —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∏ —á–µ—Ä–µ–∑ –ò–ò"""
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        answers_text = "\n".join([f"{i+1}. {answer}" for i, answer in enumerate(answers)])
        
        prompt = f"""
–¢—ã ‚Äî –ø—Å–∏—Ö–æ–ª–æ–≥-—ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–∞–º–æ–æ—Ü–µ–Ω–∫–µ, –æ–±—É—á–µ–Ω–Ω—ã–π –ø–æ –∫–Ω–∏–≥–µ "–í–æ—Å—Ö–æ–∂–¥–µ–Ω–∏–µ". 

–û–¢–í–ï–¢–´ –ù–ê –¢–ï–°–¢ (10 –∫–ª—é—á–µ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤):
{answers_text}

–ü–†–û–í–ï–î–ò –ê–ù–ê–õ–ò–ó –ù–ê –û–°–ù–û–í–ï –ö–ù–ò–ì–ò "–í–û–°–•–û–ñ–î–ï–ù–ò–ï":

üìä **–û–ë–©–ò–ô –£–†–û–í–ï–ù–¨ –°–ê–ú–û–û–¶–ï–ù–ö–ò (1-10)**
[–û—Ü–µ–Ω–∫–∞ –∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]

üíé **–°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´**
[–ß—Ç–æ —É–∂–µ —Ö–æ—Ä–æ—à–æ —Ä–∞–∑–≤–∏—Ç–æ, –Ω–∞ —á—Ç–æ –æ–ø–∏—Ä–∞—Ç—å—Å—è]

‚ö†Ô∏è **–û–ë–õ–ê–°–¢–ò –î–õ–Ø –†–û–°–¢–ê**
[–ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è –∏ —Ä–∞–∑–≤–∏—Ç–∏—è]

üéØ **–ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò**
[3-4 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –∫–Ω–∏–≥–∏]

‚ú® **–£–ü–†–ê–ñ–ù–ï–ù–ò–Ø –ò–ó –ö–ù–ò–ì–ò "–í–û–°–•–û–ñ–î–ï–ù–ò–ï"**
[2-3 –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è]

–ü–†–ò–ù–¶–ò–ü–´ –ö–ù–ò–ì–ò:
- "–î–ª—è –º–µ–Ω—è —Å–æ–∑–¥–∞–Ω –º–∏—Ä" - –∫–∞–∂–¥—ã–π –≤–∞–∂–µ–Ω
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–∏–ª—ã - –∫–æ—Ä–µ–Ω—å –≤–Ω–µ—à–Ω–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
- –°–∞–º–æ—É–≤–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –æ—Å–æ–∑–Ω–∞–Ω–∏–µ —Å–≤–æ–µ–π —Ü–µ–Ω–Ω–æ—Å—Ç–∏
- –í–µ—Ä–∞ –≤ —Å–µ–±—è —á–µ—Ä–µ–∑ –≤–µ—Ä—É –≤ –¢–≤–æ—Ä—Ü–∞

–°–¢–ò–õ–¨: –≠–º–ø–∞—Ç–∏—á–Ω—ã–π, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π. 400-600 —Å–ª–æ–≤.
"""
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò
        ai_response = await self.ai_client.get_response(
            prompt=prompt,
            user_id=user_id,
            prompt_type=PromptType.SELF_ESTEEM_ANALYSIS
        )
        
        return ai_response.content
    
    async def _analyze_full_personality(self, user_id: int, answers: list) -> str:
        """–ê–Ω–∞–ª–∏–∑ –ø–æ–ª–Ω–æ–π –ª–∏—á–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –ò–ò"""
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
        answers_text = "\n".join([f"{i+1}. {answer}" for i, answer in enumerate(answers)])
        
        prompt = f"""
–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π –ø—Å–∏—Ö–æ–∞–Ω–∞–ª–∏—Ç–∏–∫ –∏ HR-—ç–∫—Å–ø–µ—Ä—Ç —Å 20-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º.

–î–ï–¢–ê–õ–¨–ù–´–ï –û–¢–í–ï–¢–´ –ö–õ–ò–ï–ù–¢–ê:
{answers_text}

–ü–†–û–í–ï–î–ò –ì–õ–£–ë–û–ö–ò–ô –ü–°–ò–•–û–ê–ù–ê–õ–ò–ó:

üß† **–ü–°–ò–•–û–ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–§–ò–õ–¨:**
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–∏—á–Ω–æ—Å—Ç–∏ (–ò–¥/–≠–≥–æ/–°—É–ø–µ—Ä—ç–≥–æ)
- –ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã
- –ë–µ—Å—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
- –¢—Ä–∞–≤–º—ã –∏ –∏—Ö –≤–ª–∏—è–Ω–∏–µ

üé≠ **–ê–†–•–ï–¢–ò–ü–´ –ò –¢–ò–ü–û–õ–û–ì–ò–Ø:**
- –î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π –∞—Ä—Ö–µ—Ç–∏–ø –ø–æ –Æ–Ω–≥—É
- MBTI —Ç–∏–ø —Å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ–º
- –¢–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

üìä **BIG FIVE (OCEAN):**
- –û—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å: [1-10] + –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ
- –î–æ–±—Ä–æ—Å–æ–≤–µ—Å—Ç–Ω–æ—Å—Ç—å: [1-10] + –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ  
- –≠–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è: [1-10] + –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ
- –î–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: [1-10] + –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ
- –ù–µ–π—Ä–æ—Ç–∏–∑–º: [1-10] + –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ

üíº **HR-–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:**
- –ü–æ–¥—Ö–æ–¥—è—â–∏–µ —Ä–æ–ª–∏ –∏ –ø–æ–∑–∏—Ü–∏–∏
- –°—Ç–∏–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è/—Ä–∞–±–æ—Ç—ã
- –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
- –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏

üéì **–û–ë–†–ê–ó–û–í–ê–¢–ï–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:**
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—É—á–µ–Ω–∏—è
- –§–æ—Ä–º–∞—Ç—ã –æ–±—É—á–µ–Ω–∏—è (–æ—á–Ω–æ–µ/–∑–∞–æ—á–Ω–æ–µ)
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏
- –ö–∞—Ä—å–µ—Ä–Ω–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è

üîÆ **–ü–†–û–ì–ù–û–ó –†–ê–ó–í–ò–¢–ò–Ø:**
- –ö–∞–∫ –±—É–¥–µ—Ç —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è –ª–∏—á–Ω–æ—Å—Ç—å
- –ö–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ —Ä–æ—Å—Ç–∞
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏—é

–°–¢–ò–õ–¨: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –¥–µ—Ç–∞–ª—å–Ω—ã–π, –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π. 1200-1500 —Å–ª–æ–≤.
"""
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò
        ai_response = await self.ai_client.get_response(
            prompt=prompt,
            user_id=user_id,
            prompt_type=PromptType.FULL_ANALYSIS
        )
        
        return ai_response.content
    
    async def _send_analysis_result(self, update: Update, result: str):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞"""
        
        # –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —á–∞—Å—Ç–∏
        max_length = 4000
        if len(result) <= max_length:
            await update.message.reply_text(result, parse_mode=ParseMode.MARKDOWN)
        else:
            parts = [result[i:i+max_length] for i in range(0, len(result), max_length)]
            for i, part in enumerate(parts):
                prefix = f"**–ê–Ω–∞–ª–∏–∑ (—á–∞—Å—Ç—å {i+1}/{len(parts)}):**\n\n" if i > 0 else ""
                await update.message.reply_text(prefix + part, parse_mode=ParseMode.MARKDOWN)
    
    def _get_next_question(self, question_num: int) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ —Ç–µ—Å—Ç–∞ —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∏ (10 –≤–æ–ø—Ä–æ—Å–æ–≤)"""
        
        # –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç - 10 –∫–ª—é—á–µ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ –∫–Ω–∏–≥–∏ "–í–æ—Å—Ö–æ–∂–¥–µ–Ω–∏–µ"
        questions = [
            "–ö–∞–∫ –≤—ã –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç–µ —Å–≤–æ—é —Ü–µ–Ω–Ω–æ—Å—Ç—å –∫–∞–∫ –ª–∏—á–Ω–æ—Å—Ç–∏? (1-10)",
            "–ù–∞—Å–∫–æ–ª—å–∫–æ –≤—ã –¥–æ–≤–æ–ª—å–Ω—ã —Å–æ–±–æ–π –∏ —Å–≤–æ–∏–º–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏?",
            "–í–µ—Ä–∏—Ç–µ –ª–∏ –≤—ã –≤ —Å–≤–æ–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏?",
            "–ö–∞–∫–∏–µ —Å—Ç—Ä–∞—Ö–∏ —á–∞—â–µ –≤—Å–µ–≥–æ –º–µ—à–∞—é—Ç –≤–∞–º –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å?",
            "–ö–∞–∫ —á–∞—Å—Ç–æ –≤—ã –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç–µ –≥–Ω–µ–≤ –∏–ª–∏ —Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ?",
            "–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –æ–±–∏–¥—ã –Ω–∞ –ª—é–¥–µ–π –∏–∑ –ø—Ä–æ—à–ª–æ–≥–æ?",
            "–ó–Ω–∞–µ—Ç–µ –ª–∏ –≤—ã —Å–≤–æ–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∂–∏–∑–Ω–∏?",
            "–ß—Ç–æ –ø—Ä–∏–¥–∞–µ—Ç —Å–º—ã—Å–ª –≤–∞—à–µ–π –∂–∏–∑–Ω–∏?",
            "–ö–∞–∫ –≤—ã –ø—Ä–æ—è–≤–ª—è–µ—Ç–µ –ª—é–±–æ–≤—å –∫ —Å–µ–±–µ?",
            "–ß—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª–∏ –≤—ã —Å–µ–±—è —Å–≤–æ–±–æ–¥–Ω—ã–º –±—ã—Ç—å —Å–æ–±–æ–π?"
        ]
        
        if question_num < len(questions):
            progress = f"‚îÅ" * question_num + "‚óã" + "‚îÅ" * (10 - question_num - 1)
            return f"**–í–æ–ø—Ä–æ—Å {question_num + 1} –∏–∑ 10:**\n{questions[question_num]}\n\n{progress}"
        
        return "–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã!"